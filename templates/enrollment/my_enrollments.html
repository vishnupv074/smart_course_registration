{% extends 'base.html' %}

{% block title %}My Enrollments - SmartReg{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        background: var(--primary-gradient);
        color: white;
        padding: 2.5rem 0;
        margin: -2rem -15px 2rem;
        border-radius: 0 0 var(--radius-2xl) var(--radius-2xl);
    }

    .section-card {
        border-left: 4px solid var(--success);
        margin-bottom: 1rem;
    }

    .waitlist-card {
        border-left: 4px solid var(--warning);
    }

    .course-info {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .course-icon {
        width: 50px;
        height: 50px;
        border-radius: var(--radius-lg);
        background: var(--primary-gradient);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
    }

    .empty-state i {
        font-size: 4rem;
        color: var(--gray-300);
        margin-bottom: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-2">
                    <i class="fas fa-graduation-cap me-2"></i>My Enrollments
                </h1>
                <p class="mb-0 opacity-75">Manage your course enrollments and waitlists</p>
            </div>
            <a href="{% url 'courses' %}" class="btn btn-light hover-lift">
                <i class="fas fa-search me-2"></i>Browse Courses
            </a>
        </div>
    </div>
</div>

{% if enrollments %}
<h4 class="mb-3">
    <i class="fas fa-check-circle text-success me-2"></i>Active Enrollments
    <span class="badge bg-success ms-2">{{ enrollments|length }}</span>
</h4>

<div class="row">
    {% for enrollment in enrollments %}
    <div class="col-12 mb-3">
        <div class="card section-card hover-lift">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="course-info">
                            <div class="course-icon">
                                <i class="fas fa-book"></i>
                            </div>
                            <div>
                                <h5 class="mb-1">
                                    <span class="text-primary fw-bold">{{ enrollment.section.course.code }}</span>
                                    <span class="mx-2">•</span>
                                    {{ enrollment.section.course.title }}
                                </h5>
                                <p class="text-muted mb-0">
                                    <i class="fas fa-user me-1"></i>
                                    {{ enrollment.section.instructor.display_name }}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mt-3 mt-md-0">
                        <div class="mb-2">
                            <i class="fas fa-clock text-muted me-2"></i>
                            <small>{{ enrollment.section.schedule }}</small>
                        </div>
                        <div class="mb-2">
                            <i class="fas fa-door-open text-muted me-2"></i>
                            <small>{{ enrollment.section.room_number }}</small>
                        </div>
                        <div>
                            <i class="fas fa-calendar text-muted me-2"></i>
                            <small>{{ enrollment.section.semester }}</small>
                        </div>
                    </div>
                    <div class="col-md-3 mt-3 mt-md-0 text-md-end">
                        {% if enrollment.grade %}
                        <div class="mb-2">
                            <span class="badge bg-success">Grade: {{ enrollment.grade }}</span>
                        </div>
                        {% endif %}
                        <small class="text-muted d-block mb-2">
                            Enrolled: {{ enrollment.enrolled_at|date:"M d, Y" }}
                        </small>
                        <button class="btn btn-sm btn-outline-danger drop-btn"
                            data-section-id="{{ enrollment.section.id }}"
                            data-course-code="{{ enrollment.section.course.code }}">
                            <i class="fas fa-times me-1"></i>Drop Course
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="card">
    <div class="card-body empty-state">
        <i class="fas fa-graduation-cap"></i>
        <h5>No Enrollments Yet</h5>
        <p class="text-muted mb-4">You haven't enrolled in any courses yet.</p>
        <a href="{% url 'courses' %}" class="btn btn-primary">
            <i class="fas fa-search me-2"></i>Browse Courses
        </a>
    </div>
</div>
{% endif %}

<!-- Waitlist Section -->
{% if waitlists %}
<h4 class="mb-3 mt-5">
    <i class="fas fa-clock text-warning me-2"></i>Waitlists
    <span class="badge bg-warning text-dark ms-2">{{ waitlists|length }}</span>
</h4>

<div class="row">
    {% for waitlist in waitlists %}
    <div class="col-12 mb-3">
        <div class="card waitlist-card hover-lift">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="course-info">
                            <div class="course-icon"
                                style="background: linear-gradient(135deg, var(--warning) 0%, var(--warning-light) 100%);">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div>
                                <h5 class="mb-1">
                                    <span class="text-primary fw-bold">{{ waitlist.section.course.code }}</span>
                                    <span class="mx-2">•</span>
                                    {{ waitlist.section.course.title }}
                                </h5>
                                <p class="text-muted mb-0">
                                    <i class="fas fa-user me-1"></i>
                                    {{ waitlist.section.instructor.display_name }}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mt-3 mt-md-0">
                        <div class="mb-2">
                            <i class="fas fa-clock text-muted me-2"></i>
                            <small>{{ waitlist.section.schedule }}</small>
                        </div>
                        <div class="mb-2">
                            <i class="fas fa-door-open text-muted me-2"></i>
                            <small>{{ waitlist.section.room_number }}</small>
                        </div>
                        <div>
                            <i class="fas fa-calendar text-muted me-2"></i>
                            <small>{{ waitlist.section.semester }}</small>
                        </div>
                    </div>
                    <div class="col-md-3 mt-3 mt-md-0 text-md-end">
                        <div class="mb-2">
                            <span class="badge bg-warning text-dark">
                                <i class="fas fa-list-ol me-1"></i>Position #{{ waitlist.get_position }}
                            </span>
                        </div>
                        <small class="text-muted d-block mb-2">
                            Joined: {{ waitlist.joined_at|date:"M d, Y" }}
                        </small>
                        <button class="btn btn-sm btn-outline-danger leave-waitlist-btn"
                            data-waitlist-id="{{ waitlist.id }}" data-course-code="{{ waitlist.section.course.code }}">
                            <i class="fas fa-times me-1"></i>Leave Waitlist
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Drop Course Modal -->
<div class="modal fade" id="dropModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirm Drop Course
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to drop <strong id="dropCourseCode"></strong>?</p>
                <p class="text-danger">
                    <i class="fas fa-info-circle me-1"></i>
                    <small>This action cannot be undone.</small>
                </p>
                <div id="dropError" class="alert alert-danger d-none"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDropBtn">
                    <i class="fas fa-check me-2"></i>Drop Course
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Drop Course functionality
        const dropBtns = document.querySelectorAll('.drop-btn');
        const dropModal = new bootstrap.Modal(document.getElementById('dropModal'));
        const confirmDropBtn = document.getElementById('confirmDropBtn');
        const dropErrorDiv = document.getElementById('dropError');
        let currentSectionId = null;

        dropBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                currentSectionId = this.dataset.sectionId;
                document.getElementById('dropCourseCode').textContent = this.dataset.courseCode;
                dropErrorDiv.classList.add('d-none');
                dropModal.show();
            });
        });

        confirmDropBtn.addEventListener('click', function () {
            if (!currentSectionId) return;

            if (window.Loading) {
                window.Loading.show(confirmDropBtn, 'Dropping...');
            }

            fetch(`/api/drop/${currentSectionId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        if (window.Toast) {
                            window.Toast.success('Successfully dropped the course!');
                        }
                        setTimeout(() => window.location.reload(), 1000);
                    } else {
                        dropErrorDiv.textContent = data.message || 'Drop failed';
                        dropErrorDiv.classList.remove('d-none');
                        if (window.Loading) {
                            window.Loading.hide(confirmDropBtn);
                        }
                    }
                })
                .catch(error => {
                    dropErrorDiv.textContent = 'Network error occurred';
                    dropErrorDiv.classList.remove('d-none');
                    if (window.Loading) {
                        window.Loading.hide(confirmDropBtn);
                    }
                });
        });

        // Leave Waitlist functionality
        const leaveWaitlistBtns = document.querySelectorAll('.leave-waitlist-btn');

        leaveWaitlistBtns.forEach(btn => {
            btn.addEventListener('click', function () {
                const waitlistId = this.dataset.waitlistId;
                const courseCode = this.dataset.courseCode;

                if (confirm(`Are you sure you want to leave the waitlist for ${courseCode}?`)) {
                    if (window.Loading) {
                        window.Loading.show(btn, 'Leaving...');
                    }

                    fetch(`/api/waitlist/leave/${waitlistId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json'
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                if (window.Toast) {
                                    window.Toast.success('Successfully left the waitlist!');
                                }
                                setTimeout(() => window.location.reload(), 1000);
                            } else {
                                if (window.Toast) {
                                    window.Toast.error(data.message || 'Failed to leave waitlist');
                                }
                                if (window.Loading) {
                                    window.Loading.hide(btn);
                                }
                            }
                        })
                        .catch(error => {
                            if (window.Toast) {
                                window.Toast.error('Network error occurred');
                            }
                            if (window.Loading) {
                                window.Loading.hide(btn);
                            }
                        });
                }
            });
        });
    });
</script>
{% endblock %}