{% extends 'base.html' %}

{% block title %}Monitoring & Statistics - ADBMS Demo{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
        color: white;
        padding: 3rem 0;
        margin: -2rem -15px 2.5rem;
        border-radius: 0 0 var(--radius-2xl) var(--radius-2xl);
    }

    .metric-card {
        background: var(--card-bg);
        border: 2px solid var(--border-color);
        border-radius: var(--radius-xl);
        padding: 1.5rem;
        transition: all var(--transition-base);
        height: 100%;
    }

    .metric-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary-start);
    }

    .metric-icon {
        width: 50px;
        height: 50px;
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 1rem;
        background: var(--primary-gradient);
        color: white;
    }

    .metric-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
    }

    .metric-label {
        font-size: 0.875rem;
        color: var(--text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .query-table {
        background: var(--card-bg);
        border-radius: var(--radius-xl);
        overflow: hidden;
        border: 2px solid var(--border-color);
    }

    .query-table th {
        background: var(--primary-gradient);
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.875rem;
        letter-spacing: 0.05em;
        padding: 1rem;
        border: none;
    }

    .query-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        vertical-align: middle;
    }

    .query-table tbody tr {
        transition: all var(--transition-base);
    }

    .query-table tbody tr:hover {
        background: var(--hover-bg);
    }

    .query-text {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.875rem;
        color: var(--text-secondary);
        max-width: 400px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        cursor: pointer;
    }

    .query-text:hover {
        color: var(--primary-start);
    }

    .badge-metric {
        padding: 0.375rem 0.75rem;
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        font-weight: 600;
    }

    .badge-fast {
        background: linear-gradient(135deg, var(--success) 0%, var(--success-light) 100%);
        color: white;
    }

    .badge-medium {
        background: linear-gradient(135deg, var(--warning) 0%, var(--warning-light) 100%);
        color: white;
    }

    .badge-slow {
        background: linear-gradient(135deg, var(--danger) 0%, var(--danger-light) 100%);
        color: white;
    }

    .chart-container {
        background: var(--card-bg);
        border: 2px solid var(--border-color);
        border-radius: var(--radius-xl);
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .section-header {
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--border-color);
    }

    .section-header h3 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin: 0;
    }

    .error-alert {
        background: linear-gradient(135deg, var(--danger) 0%, var(--danger-light) 100%);
        color: white;
        padding: 1.5rem;
        border-radius: var(--radius-xl);
        margin-bottom: 2rem;
    }

    .query-details {
        background: var(--hover-bg);
        border-left: 4px solid var(--primary-start);
        padding: 1rem;
        margin-top: 0.5rem;
        border-radius: var(--radius-md);
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.875rem;
        white-space: pre-wrap;
        word-break: break-all;
        display: none;
    }

    .query-details.show {
        display: block;
        animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header text-center">
    <div class="container">
        <h1 class="mb-3">
            <i class="fas fa-chart-bar me-2"></i>{{ results.demo_name }}
        </h1>
        <p class="mb-0 opacity-75">
            {{ results.description }}
        </p>
    </div>
</div>

{% if results.error %}
<div class="error-alert">
    <h4><i class="fas fa-exclamation-triangle me-2"></i>Error</h4>
    <p class="mb-0">{{ results.error }}</p>
</div>
{% else %}

<!-- Performance Metrics -->
<div class="section-header">
    <h3><i class="fas fa-tachometer-alt me-2"></i>Performance Metrics</h3>
</div>

<div class="row g-4 mb-4">
    <div class="col-md-6 col-lg-3">
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-database"></i>
            </div>
            <div class="metric-value">{{ results.metrics.total_queries }}</div>
            <div class="metric-label">Unique Queries</div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-redo"></i>
            </div>
            <div class="metric-value">{{ results.metrics.total_calls }}</div>
            <div class="metric-label">Total Executions</div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="metric-value">{{ results.metrics.avg_mean_time }}ms</div>
            <div class="metric-label">Avg Execution Time</div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="metric-card">
            <div class="metric-icon">
                <i class="fas fa-bolt"></i>
            </div>
            <div class="metric-value">{{ results.metrics.cache_hit_ratio }}%</div>
            <div class="metric-label">Cache Hit Ratio</div>
        </div>
    </div>
</div>

<!-- Latency Histogram -->
<div class="section-header">
    <h3><i class="fas fa-chart-line me-2"></i>Query Latency Distribution</h3>
</div>

<div class="chart-container">
    <canvas id="latencyChart" height="80"></canvas>
</div>

<!-- Top Queries Table -->
<div class="section-header">
    <h3><i class="fas fa-list me-2"></i>Top Queries by Total Execution Time</h3>
</div>

<div class="query-table">
    <table class="table table-hover mb-0">
        <thead>
            <tr>
                <th style="width: 5%;">#</th>
                <th style="width: 40%;">Query</th>
                <th style="width: 10%;">Calls</th>
                <th style="width: 12%;">Total Time</th>
                <th style="width: 12%;">Mean Time</th>
                <th style="width: 11%;">Min/Max</th>
                <th style="width: 10%;">Rows</th>
            </tr>
        </thead>
        <tbody>
            {% for query in results.top_queries %}
            <tr>
                <td class="text-center">{{ forloop.counter }}</td>
                <td>
                    <div class="query-text" onclick="toggleQueryDetails({{ forloop.counter }})">
                        {{ query.query }}
                    </div>
                    <div id="query-details-{{ forloop.counter }}" class="query-details">
                        {{ query.full_query }}
                    </div>
                </td>
                <td>{{ query.calls }}</td>
                <td>
                    <span
                        class="badge {% if query.total_time < 1 %}badge-fast{% elif query.total_time < 10 %}badge-medium{% else %}badge-slow{% endif %}">
                        {{ query.total_time }}ms
                    </span>
                </td>
                <td>
                    <span
                        class="badge {% if query.mean_time < 0.5 %}badge-fast{% elif query.mean_time < 5 %}badge-medium{% else %}badge-slow{% endif %}">
                        {{ query.mean_time }}ms
                    </span>
                </td>
                <td>
                    <small class="text-muted">{{ query.min_time }} / {{ query.max_time }}ms</small>
                </td>
                <td>{{ query.rows }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" class="text-center text-muted py-4">
                    No query statistics available. Execute some queries to generate data.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endif %}

<div class="text-center mt-4">
    <a href="{% url 'adbms-dashboard' %}" class="btn btn-outline-primary">
        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    function toggleQueryDetails(index) {
        const details = document.getElementById('query-details-' + index);
        details.classList.toggle('show');
    }

    {% if not results.error and results.latency_histogram.labels %}
    // Latency Histogram Chart
    const ctx = document.getElementById('latencyChart').getContext('2d');
    const labels = {{ results.latency_histogram.labels| safe }};
    const data = {{ results.latency_histogram.data| safe }};

    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(124, 58, 237, 0.8)');
    gradient.addColorStop(1, 'rgba(59, 130, 246, 0.8)');

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Number of Queries',
                data: data,
                backgroundColor: gradient,
                borderColor: 'rgba(124, 58, 237, 1)',
                borderWidth: 2,
                borderRadius: 8,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Query Distribution by Latency Range',
                    font: {
                        size: 16,
                        weight: 'bold'
                    },
                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim()
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim()
                    },
                    grid: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim()
                    }
                },
                x: {
                    ticks: {
                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim()
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
    {% endif %}
</script>
{% endblock %}