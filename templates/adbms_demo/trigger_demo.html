{% extends 'base.html' %}
{% load static %}

{% block title %}Triggers & Stored Procedures - ADBMS Demo{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-1 fw-bold text-gradient">Triggers & Stored Procedures</h1>
            <p class="text-muted mb-0">Automatic audit logging using PL/pgSQL functions</p>
        </div>
        <a href="{% url 'adbms-dashboard' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
        </a>
    </div>

    <!-- Theory Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm glass-card">
                <div class="card-header bg-transparent border-0">
                    <h5 class="card-title mb-0 fw-bold"><i class="bi bi-lightbulb me-2 text-warning"></i>Concept:
                        Database Triggers</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p>
                                A <strong>Database Trigger</strong> is a procedural code that is automatically executed
                                in response to certain events on a particular table or view in a database.
                                In this demo, we use <strong>AFTER INSERT/UPDATE/DELETE</strong> triggers to
                                automatically log every change to critical tables into a central <code>AuditLog</code>
                                table.
                            </p>
                            <h6 class="fw-bold mt-3">How it works:</h6>
                            <ol class="small text-muted">
                                <li>User performs an action (e.g., updates a grade).</li>
                                <li>PostgreSQL executes the <code>UPDATE</code> statement.</li>
                                <li>The <code>AFTER UPDATE</code> trigger fires immediately.</li>
                                <li>The PL/pgSQL function <code>audit_enrollment_changes()</code> runs.</li>
                                <li>It captures <code>OLD</code> (before) and <code>NEW</code> (after) data.</li>
                                <li>It inserts a record into the <code>AuditLog</code> table.</li>
                            </ol>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-info border-0 bg-info-subtle">
                                <h6 class="alert-heading fw-bold"><i class="bi bi-info-circle me-2"></i>Database vs
                                    Application Auditing</h6>
                                <p class="small mb-0">Why use database triggers instead of Django signals?</p>
                            </div>
                            <table class="table table-sm table-borderless small">
                                <thead class="text-muted">
                                    <tr>
                                        <th>Feature</th>
                                        <th>Database Triggers (PL/pgSQL)</th>
                                        <th>App Logic (Django Signals)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Reliability</strong></td>
                                        <td class="text-success"><i class="bi bi-check-circle me-1"></i>Captures ALL
                                            changes (SQL, Admin, App)</td>
                                        <td class="text-danger"><i class="bi bi-x-circle me-1"></i>Misses direct
                                            SQL/bulk updates</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Performance</strong></td>
                                        <td class="text-success"><i class="bi bi-check-circle me-1"></i>Fast (runs
                                            inside DB)</td>
                                        <td class="text-warning"><i class="bi bi-dash-circle me-1"></i>Slower (Python
                                            overhead)</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Maintenance</strong></td>
                                        <td class="text-warning"><i class="bi bi-dash-circle me-1"></i>Requires SQL
                                            knowledge</td>
                                        <td class="text-success"><i class="bi bi-check-circle me-1"></i>Easier (Python
                                            code)</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Demo Controls -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header border-0">
                    <ul class="nav nav-tabs card-header-tabs" id="demoTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="enrollment-tab" data-bs-toggle="tab"
                                data-bs-target="#enrollment-pane" type="button" role="tab">Enrollment Table</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="course-tab" data-bs-toggle="tab" data-bs-target="#course-pane"
                                type="button" role="tab">Course Table</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="section-tab" data-bs-toggle="tab"
                                data-bs-target="#section-pane" type="button" role="tab">Section Table</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="waitlist-tab" data-bs-toggle="tab"
                                data-bs-target="#waitlist-pane" type="button" role="tab">Waitlist Table</button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="demoTabsContent">
                        <!-- Enrollment Controls -->
                        <div class="tab-pane fade show active" id="enrollment-pane" role="tabpanel">
                            <div class="d-flex gap-3 align-items-center flex-wrap">
                                <form method="POST" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="table" value="enrollment">
                                    <input type="hidden" name="action" value="create">
                                    <button type="submit" class="btn btn-success text-white mb-2">
                                        <i class="bi bi-plus-circle me-2"></i>Create Enrollment
                                    </button>
                                </form>
                                <i class="bi bi-arrow-right text-muted d-none d-md-block mb-2"></i>
                                <form method="POST" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="table" value="enrollment">
                                    <input type="hidden" name="action" value="update">
                                    <button type="submit" class="btn btn-primary text-white mb-2">
                                        <i class="bi bi-pencil me-2"></i>Update Grade
                                    </button>
                                </form>
                                <i class="bi bi-arrow-right text-muted d-none d-md-block mb-2"></i>
                                <form method="POST" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="table" value="enrollment">
                                    <input type="hidden" name="action" value="delete">
                                    <button type="submit" class="btn btn-danger text-white mb-2">
                                        <i class="bi bi-trash me-2"></i>Delete Enrollment
                                    </button>
                                </form>
                            </div>
                            <p class="text-muted small mt-2 mb-0">Simulates a student enrolling, grade changing, and
                                dropping a course.</p>
                        </div>

                        <!-- Course Controls -->
                        <div class="tab-pane fade" id="course-pane" role="tabpanel">
                            <div class="d-flex gap-3 align-items-center flex-wrap">
                                <form method="POST" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="table" value="course">
                                    <input type="hidden" name="action" value="create">
                                    <button type="submit" class="btn btn-success text-white mb-2">
                                        <i class="bi bi-plus-circle me-2"></i>Create Course
                                    </button>
                                </form>
                                <i class="bi bi-arrow-right text-muted d-none d-md-block mb-2"></i>
                                <form method="POST" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="table" value="course">
                                    <input type="hidden" name="action" value="update">
                                    <button type="submit" class="btn btn-primary text-white mb-2">
                                        <i class="bi bi-pencil me-2"></i>Update Credits
                                    </button>
                                </form>
                                <i class="bi bi-arrow-right text-muted d-none d-md-block mb-2"></i>
                                <form method="POST" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="table" value="course">
                                    <input type="hidden" name="action" value="delete">
                                    <button type="submit" class="btn btn-danger text-white mb-2">
                                        <i class="bi bi-trash me-2"></i>Delete Course
                                    </button>
                                </form>
                            </div>
                            <p class="text-muted small mt-2 mb-0">Simulates creating a new course, changing credits, and
                                deleting it.</p>
                        </div>

                        <!-- Section Controls -->
                        <div class="tab-pane fade" id="section-pane" role="tabpanel">
                            <div class="d-flex gap-3 align-items-center flex-wrap">
                                <form method="POST" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="table" value="section">
                                    <input type="hidden" name="action" value="create">
                                    <button type="submit" class="btn btn-success text-white mb-2">
                                        <i class="bi bi-plus-circle me-2"></i>Create Section
                                    </button>
                                </form>
                                <i class="bi bi-arrow-right text-muted d-none d-md-block mb-2"></i>
                                <form method="POST" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="table" value="section">
                                    <input type="hidden" name="action" value="update">
                                    <button type="submit" class="btn btn-primary text-white mb-2">
                                        <i class="bi bi-pencil me-2"></i>Update Capacity
                                    </button>
                                </form>
                                <i class="bi bi-arrow-right text-muted d-none d-md-block mb-2"></i>
                                <form method="POST" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="table" value="section">
                                    <input type="hidden" name="action" value="delete">
                                    <button type="submit" class="btn btn-danger text-white mb-2">
                                        <i class="bi bi-trash me-2"></i>Delete Section
                                    </button>
                                </form>
                            </div>
                            <p class="text-muted small mt-2 mb-0">Simulates scheduling a section, changing capacity, and
                                cancelling it.</p>
                        </div>

                        <!-- Waitlist Controls -->
                        <div class="tab-pane fade" id="waitlist-pane" role="tabpanel">
                            <div class="d-flex gap-3 align-items-center flex-wrap">
                                <form method="POST" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="table" value="waitlist">
                                    <input type="hidden" name="action" value="create">
                                    <button type="submit" class="btn btn-success text-white mb-2">
                                        <i class="bi bi-plus-circle me-2"></i>Join Waitlist
                                    </button>
                                </form>
                                <i class="bi bi-arrow-right text-muted d-none d-md-block mb-2"></i>
                                <form method="POST" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="table" value="waitlist">
                                    <input type="hidden" name="action" value="update">
                                    <button type="submit" class="btn btn-primary text-white mb-2">
                                        <i class="bi bi-pencil me-2"></i>Toggle Notification
                                    </button>
                                </form>
                                <i class="bi bi-arrow-right text-muted d-none d-md-block mb-2"></i>
                                <form method="POST" class="d-inline">
                                    {% csrf_token %}
                                    <input type="hidden" name="table" value="waitlist">
                                    <input type="hidden" name="action" value="delete">
                                    <button type="submit" class="btn btn-danger text-white mb-2">
                                        <i class="bi bi-trash me-2"></i>Leave Waitlist
                                    </button>
                                </form>
                            </div>
                            <p class="text-muted small mt-2 mb-0">Simulates joining waitlist, notification status
                                change, and leaving.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Audit Log Table -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0 fw-bold">Audit Log (Live)</h5>
            <div class="d-flex gap-2">
                <span class="badge bg-success-subtle text-success border border-success-subtle">INSERT:
                    {{stats.insert}}</span>
                <span class="badge bg-primary-subtle text-primary border border-primary-subtle">UPDATE:
                    {{stats.update}}</span>
                <span class="badge bg-danger-subtle text-danger border border-danger-subtle">DELETE:
                    {{stats.delete}}</span>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Time</th>
                        <th>Table</th>
                        <th>Operation</th>
                        <th>Change Summary</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr>
                        <td class="text-muted small">{{ log.changed_at|date:"H:i:s" }}</td>
                        <td><code>{{ log.table_name }}</code></td>
                        <td>
                            {% if log.operation == 'INSERT' %}
                            <span class="badge bg-success">INSERT</span>
                            {% elif log.operation == 'UPDATE' %}
                            <span class="badge bg-primary">UPDATE</span>
                            {% else %}
                            <span class="badge bg-danger">DELETE</span>
                            {% endif %}
                        </td>
                        <td>{{ log.change_summary }}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                                data-bs-target="#log-details-{{ log.id }}">
                                <i class="bi bi-code-slash"></i>
                            </button>
                        </td>
                    </tr>
                    <tr class="collapse bg-light" id="log-details-{{ log.id }}">
                        <td colspan="5">
                            <div class="p-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-danger small fw-bold">OLD DATA (Before)</h6>
                                        <pre
                                            class="bg-white p-2 border rounded small"><code>{{ log.old_data|pprint }}</code></pre>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-success small fw-bold">NEW DATA (After)</h6>
                                        <pre
                                            class="bg-white p-2 border rounded small"><code>{{ log.new_data|pprint }}</code></pre>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center py-4 text-muted">
                            <i class="bi bi-database display-6 d-block mb-2"></i>
                            No audit logs found yet. Try performing some actions above!
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .glass-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .text-gradient {
        background: linear-gradient(45deg, #4e73df, #36b9cc);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    pre {
        max-height: 200px;
        overflow-y: auto;
    }

    /* Override global nav-link styles which are designed for navbar only */
    .nav-tabs .nav-link {
        color: var(--primary-start) !important;
        background: transparent !important;
    }

    .nav-tabs .nav-link:hover {
        color: var(--primary-end) !important;
        background-color: rgba(0, 0, 0, 0.05) !important;
        transform: none !important;
    }

    .nav-tabs .nav-link.active {
        color: var(--text-primary) !important;
        background-color: var(--bg-primary) !important;
        border-color: var(--border-color) var(--border-color) var(--bg-primary) !important;
        font-weight: bold;
    }

    /* Dark mode overrides */
    [data-theme="dark"] .nav-tabs .nav-link.active {
        color: var(--bs-light) !important;
        background-color: var(--bs-dark) !important;
        border-color: var(--bs-gray-700) var(--bs-gray-700) var(--bs-dark) !important;
    }
</style>
{% endblock %}